name: build-latest-rootfs

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        arch: [x86_64, aarch64]  # add whatever archs you want
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y bsdtar curl wget tar jq qemu-user-static

      - name: setup qemu for non-x86_64
        if: matrix.arch != 'x86_64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.arch }}

      - name: build alpine rootfs
        run: |
          chmod +x scripts/create_alpine_latest.sh
          if [ "${{ matrix.arch }}" != "x86_64" ]; then
              docker run --rm --platform "linux/${{ matrix.arch }}" -v $PWD:/work -w /work ubuntu:22.04 \
                  bash -c "apt update && apt install -y curl wget tar bsdtar && ./scripts/create_alpine_latest.sh ${{ matrix.arch }}"
          else
              ./scripts/create_alpine_latest.sh x86_64
          fi
          ls -la Alpine/${{ matrix.arch }}

      - name: resolve latest tarball
        id: artifact
        run: |
          file=$(ls -1 Alpine/${{ matrix.arch }}/Alpine-*.tgz | sort -V | tail -1)
          echo "${file##*/}" | sed -e 's/^Alpine-//' -e 's/\.tgz$//' > ./alpine-version
          sudo mv "$file" Alpine/${{matrix.arch }}/Alpine.tgz
          echo "file=Alpine/${{matrix.arch }}/Alpine.tgz" >> $GITHUB_OUTPUT
          echo "name=Alpine.tgz" >> $GITHUB_OUTPUT

      - name: create or update latest tag
        run: |
          tag=alpine-${{ matrix.arch }}-latest
          git tag -f $tag
          git push origin $tag --force

      - name: create or update release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag=alpine-${{ matrix.arch }}-latest
          name=alpine-${{ matrix.arch }}-latest

          notes="auto-built from commit $GITHUB_SHA, built using Alpine v$(cat ./alpine-version) "

          if gh release view "$tag" >/dev/null 2>&1; then
            gh release edit "$tag" --title "$name" --notes "$notes"
          else
            gh release create "$tag" --title "$name" --notes "$notes"
          fi

      - name: replace release asset
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag=alpine-${{ matrix.arch }}-latest
          asset="${{ steps.artifact.outputs.name }}"
          path="${{ steps.artifact.outputs.file }}"

          gh release view "$tag" --json assets -q '.assets[].name' \
            | grep -x "$asset" \
            && gh release delete-asset "$tag" "$asset" -y \
            || true

          gh release upload "$tag" "$path" --clobber

